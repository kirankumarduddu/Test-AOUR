import pandas 
import os 
 
# This query represents dataset "Warfarin Sample 2" for domain "person" and was generated for All of Us Registered Tier Dataset v6 
dataset_77836918_person_sql = """ 
    SELECT 
        person.person_id, 
        person.gender_concept_id, 
        p_gender_concept.concept_name as gender, 
        person.birth_datetime as date_of_birth, 
        person.race_concept_id, 
        p_race_concept.concept_name as race, 
        person.ethnicity_concept_id, 
        p_ethnicity_concept.concept_name as ethnicity, 
        person.sex_at_birth_concept_id, 
        p_sex_at_birth_concept.concept_name as sex_at_birth  
    FROM 
        `""" + os.environ["WORKSPACE_CDR"] + """.person` person  
    LEFT JOIN 
        `""" + os.environ["WORKSPACE_CDR"] + """.concept` p_gender_concept  
            ON person.gender_concept_id = p_gender_concept.concept_id  
    LEFT JOIN 
        `""" + os.environ["WORKSPACE_CDR"] + """.concept` p_race_concept  
            ON person.race_concept_id = p_race_concept.concept_id  
    LEFT JOIN 
        `""" + os.environ["WORKSPACE_CDR"] + """.concept` p_ethnicity_concept  
            ON person.ethnicity_concept_id = p_ethnicity_concept.concept_id  
    LEFT JOIN 
        `""" + os.environ["WORKSPACE_CDR"] + """.concept` p_sex_at_birth_concept  
            ON person.sex_at_birth_concept_id = p_sex_at_birth_concept.concept_id   
    WHERE 
        person.PERSON_ID IN ( 
            SELECT 
                distinct person_id   
            FROM 
                `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_person` cb_search_person   
            WHERE 
                cb_search_person.person_id IN ( 
                    SELECT 
                        criteria.person_id  
                    FROM 
                        (SELECT 
                            DISTINCT person_id, 
                            entry_date, 
                            concept_id  
                        FROM 
                            `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                        WHERE 
                            ( 
                                concept_id IN ( 
                                    SELECT 
                                        DISTINCT ca.descendant_id  
                                    FROM 
                                        `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria_ancestor` ca  
                                    JOIN 
                                        ( 
                                            select 
                                                distinct c.concept_id  
                                            FROM 
                                                `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` c  
                                            JOIN 
                                                ( 
                                                    select 
                                                        cast(cr.id as string) as id  
                                                    FROM 
                                                        `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` cr  
                                                    WHERE 
                                                        concept_id IN (1310149)  
                                                        AND full_text LIKE '%_rank1]%' 
                                                ) a  
                                                    ON ( 
                                                        c.path LIKE CONCAT('%.', 
                                                    a.id, 
                                                    '.%')  
                                                    OR c.path LIKE CONCAT('%.', 
                                                    a.id)  
                                                    OR c.path LIKE CONCAT(a.id, 
                                                    '.%')  
                                                    OR c.path = a.id)  
                                                WHERE 
                                                    is_standard = 1  
                                                    AND is_selectable = 1 
                                                ) b  
                                                    ON ( 
                                                        ca.ancestor_id = b.concept_id 
                                                    ) 
                                            )  
                                            AND is_standard = 1 
                                        ) 
                                ) criteria  
                            )  
                            AND cb_search_person.person_id IN ( 
                                SELECT 
                                    person_id  
                            FROM 
                                `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                            WHERE 
                                person_id IN ( 
                                    SELECT 
                                        person_id  
                                    FROM 
                                        `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                                    WHERE 
                                        concept_id IN ( 
                                            SELECT 
                                                DISTINCT c.concept_id  
                                            FROM 
                                                `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` c  
                                            JOIN 
                                                ( 
                                                    select 
                                                        cast(cr.id as string) as id  
                                                    FROM 
                                                        `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` cr  
                                                    WHERE 
                                                        concept_id IN (1585860, 1585857)  
                                                        AND full_text LIKE '%_rank1]%' 
                                                ) a  
                                                    ON ( 
                                                        c.path LIKE CONCAT('%.', 
                                                    a.id, 
                                                    '.%')  
                                                    OR c.path LIKE CONCAT('%.', 
                                                    a.id)  
                                                    OR c.path LIKE CONCAT(a.id, 
                                                    '.%')  
                                                    OR c.path = a.id)  
                                                WHERE 
                                                    is_standard = 0  
                                                    AND is_selectable = 1 
                                                )  
                                                AND is_standard = 0  
                                        ) 
                                    )  
                                    AND cb_search_person.person_id IN ( 
                                        SELECT 
                                            criteria.person_id  
                                        FROM 
                                            (SELECT 
                                                DISTINCT person_id, 
                                                entry_date, 
                                                concept_id  
                                            FROM 
                                                `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                                            WHERE 
                                                ( 
                                                    concept_id IN ( 
                                                        SELECT 
                                                            DISTINCT ca.descendant_id  
                                                        FROM 
                                                            `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria_ancestor` ca  
                                                        JOIN 
                                                            ( 
                                                                select 
                                                                    distinct c.concept_id  
                                                                FROM 
                                                                    `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` c  
                                                                JOIN 
                                                                    ( 
                                                                        select 
                                                                            cast(cr.id as string) as id  
                                                                        FROM 
                                                                            `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` cr  
                                                                        WHERE 
                                                                            concept_id IN (21603553)  
                                                                            AND full_text LIKE '%_rank1]%' 
                                                                    ) a  
                                                                        ON ( 
                                                                            c.path LIKE CONCAT('%.', 
                                                                        a.id, 
                                                                        '.%')  
                                                                        OR c.path LIKE CONCAT('%.', 
                                                                        a.id)  
                                                                        OR c.path LIKE CONCAT(a.id, 
                                                                        '.%')  
                                                                        OR c.path = a.id)  
                                                                    WHERE 
                                                                        is_standard = 1  
                                                                        AND is_selectable = 1 
                                                                    ) b  
                                                                        ON ( 
                                                                            ca.ancestor_id = b.concept_id 
                                                                        ) 
                                                                )  
                                                                AND is_standard = 1 
                                                            ) 
                                                    ) criteria  
                                                )  
                                                AND cb_search_person.person_id IN ( 
                                                    SELECT 
                                                        person_id  
                                                FROM 
                                                    `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                                                WHERE 
                                                    person_id IN ( 
                                                        SELECT 
                                                            person_id  
                                                        FROM 
                                                            `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                                                        WHERE 
                                                            concept_id IN ( 
                                                                SELECT 
                                                                    DISTINCT c.concept_id  
                                                                FROM 
                                                                    `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` c  
                                                                JOIN 
                                                                    ( 
                                                                        select 
                                                                            cast(cr.id as string) as id  
                                                                        FROM 
                                                                            `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` cr  
                                                                        WHERE 
                                                                            concept_id IN (1586198, 1586207)  
                                                                            AND full_text LIKE '%_rank1]%' 
                                                                    ) a  
                                                                        ON ( 
                                                                            c.path LIKE CONCAT('%.', 
                                                                        a.id, 
                                                                        '.%')  
                                                                        OR c.path LIKE CONCAT('%.', 
                                                                        a.id)  
                                                                        OR c.path LIKE CONCAT(a.id, 
                                                                        '.%')  
                                                                        OR c.path = a.id)  
                                                                    WHERE 
                                                                        is_standard = 0  
                                                                        AND is_selectable = 1 
                                                                    )  
                                                                    AND is_standard = 0  
                                                            ) 
                                                        )  
                                                )""" 
 
dataset_77836918_person_df = pandas.read_gbq( 
    dataset_77836918_person_sql, 
    dialect="standard", 
    use_bqstorage_api=("BIGQUERY_STORAGE_API_ENABLED" in os.environ), 
    progress_bar_type="tqdm_notebook") 
 
dataset_77836918_person_df.head(5) 
 

In [ ]: 

import pandas 
import os 
 
# This query represents dataset "Warfarin Sample 2" for domain "survey" and was generated for All of Us Registered Tier Dataset v6 
dataset_77836918_survey_sql = """ 
    SELECT 
        answer.person_id, 
        answer.survey_datetime, 
        answer.survey, 
        answer.question_concept_id, 
        answer.question, 
        answer.answer_concept_id, 
        answer.answer, 
        answer.survey_version_concept_id, 
        answer.survey_version_name   
    FROM 
        `""" + os.environ["WORKSPACE_CDR"] + """.ds_survey` answer    
    WHERE 
        ( 
            question_concept_id IN ( 
                1585860 
            ) 
        )   
        AND ( 
            answer.PERSON_ID IN ( 
                SELECT 
                    distinct person_id   
                FROM 
                    `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_person` cb_search_person   
                WHERE 
                    cb_search_person.person_id IN ( 
                        SELECT 
                            criteria.person_id  
                        FROM 
                            (SELECT 
                                DISTINCT person_id, 
                                entry_date, 
                                concept_id  
                            FROM 
                                `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                            WHERE 
                                ( 
                                    concept_id IN ( 
                                        SELECT 
                                            DISTINCT ca.descendant_id  
                                        FROM 
                                            `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria_ancestor` ca  
                                        JOIN 
                                            ( 
                                                select 
                                                    distinct c.concept_id  
                                                FROM 
                                                    `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` c  
                                                JOIN 
                                                    ( 
                                                        select 
                                                            cast(cr.id as string) as id  
                                                        FROM 
                                                            `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` cr  
                                                        WHERE 
                                                            concept_id IN (1310149)  
                                                            AND full_text LIKE '%_rank1]%' 
                                                    ) a  
                                                        ON ( 
                                                            c.path LIKE CONCAT('%.', 
                                                        a.id, 
                                                        '.%')  
                                                        OR c.path LIKE CONCAT('%.', 
                                                        a.id)  
                                                        OR c.path LIKE CONCAT(a.id, 
                                                        '.%')  
                                                        OR c.path = a.id)  
                                                    WHERE 
                                                        is_standard = 1  
                                                        AND is_selectable = 1 
                                                    ) b  
                                                        ON ( 
                                                            ca.ancestor_id = b.concept_id 
                                                        ) 
                                                )  
                                                AND is_standard = 1 
                                            ) 
                                    ) criteria  
                                )  
                                AND cb_search_person.person_id IN ( 
                                    SELECT 
                                        person_id  
                                FROM 
                                    `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                                WHERE 
                                    person_id IN ( 
                                        SELECT 
                                            person_id  
                                        FROM 
                                            `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                                        WHERE 
                                            concept_id IN ( 
                                                SELECT 
                                                    DISTINCT c.concept_id  
                                                FROM 
                                                    `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` c  
                                                JOIN 
                                                    ( 
                                                        select 
                                                            cast(cr.id as string) as id  
                                                        FROM 
                                                            `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` cr  
                                                        WHERE 
                                                            concept_id IN (1585860, 1585857)  
                                                            AND full_text LIKE '%_rank1]%' 
                                                    ) a  
                                                        ON ( 
                                                            c.path LIKE CONCAT('%.', 
                                                        a.id, 
                                                        '.%')  
                                                        OR c.path LIKE CONCAT('%.', 
                                                        a.id)  
                                                        OR c.path LIKE CONCAT(a.id, 
                                                        '.%')  
                                                        OR c.path = a.id)  
                                                    WHERE 
                                                        is_standard = 0  
                                                        AND is_selectable = 1 
                                                    )  
                                                    AND is_standard = 0  
                                            ) 
                                        )  
                                        AND cb_search_person.person_id IN ( 
                                            SELECT 
                                                criteria.person_id  
                                            FROM 
                                                (SELECT 
                                                    DISTINCT person_id, 
                                                    entry_date, 
                                                    concept_id  
                                                FROM 
                                                    `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                                                WHERE 
                                                    ( 
                                                        concept_id IN ( 
                                                            SELECT 
                                                                DISTINCT ca.descendant_id  
                                                            FROM 
                                                                `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria_ancestor` ca  
                                                            JOIN 
                                                                ( 
                                                                    select 
                                                                        distinct c.concept_id  
                                                                    FROM 
                                                                        `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` c  
                                                                    JOIN 
                                                                        ( 
                                                                            select 
                                                                                cast(cr.id as string) as id  
                                                                            FROM 
                                                                                `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` cr  
                                                                            WHERE 
                                                                                concept_id IN (21603553)  
                                                                                AND full_text LIKE '%_rank1]%' 
                                                                        ) a  
                                                                            ON ( 
                                                                                c.path LIKE CONCAT('%.', 
                                                                            a.id, 
                                                                            '.%')  
                                                                            OR c.path LIKE CONCAT('%.', 
                                                                            a.id)  
                                                                            OR c.path LIKE CONCAT(a.id, 
                                                                            '.%')  
                                                                            OR c.path = a.id)  
                                                                        WHERE 
                                                                            is_standard = 1  
                                                                            AND is_selectable = 1 
                                                                        ) b  
                                                                            ON ( 
                                                                                ca.ancestor_id = b.concept_id 
                                                                            ) 
                                                                    )  
                                                                    AND is_standard = 1 
                                                                ) 
                                                        ) criteria  
                                                    )  
                                                    AND cb_search_person.person_id IN ( 
                                                        SELECT 
                                                            person_id  
                                                    FROM 
                                                        `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                                                    WHERE 
                                                        person_id IN ( 
                                                            SELECT 
                                                                person_id  
                                                            FROM 
                                                                `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                                                            WHERE 
                                                                concept_id IN ( 
                                                                    SELECT 
                                                                        DISTINCT c.concept_id  
                                                                    FROM 
                                                                        `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` c  
                                                                    JOIN 
                                                                        ( 
                                                                            select 
                                                                                cast(cr.id as string) as id  
                                                                            FROM 
                                                                                `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` cr  
                                                                            WHERE 
                                                                                concept_id IN (1586198, 1586207)  
                                                                                AND full_text LIKE '%_rank1]%' 
                                                                        ) a  
                                                                            ON ( 
                                                                                c.path LIKE CONCAT('%.', 
                                                                            a.id, 
                                                                            '.%')  
                                                                            OR c.path LIKE CONCAT('%.', 
                                                                            a.id)  
                                                                            OR c.path LIKE CONCAT(a.id, 
                                                                            '.%')  
                                                                            OR c.path = a.id)  
                                                                        WHERE 
                                                                            is_standard = 0  
                                                                            AND is_selectable = 1 
                                                                        )  
                                                                        AND is_standard = 0  
                                                                ) 
                                                            )  
                                                    ) 
                                                )""" 
 
dataset_77836918_survey_df = pandas.read_gbq( 
    dataset_77836918_survey_sql, 
    dialect="standard", 
    use_bqstorage_api=("BIGQUERY_STORAGE_API_ENABLED" in os.environ), 
    progress_bar_type="tqdm_notebook") 
 
dataset_77836918_survey_df.head(5) 
 

In [ ]: 

import pandas 
import os 
 
# This query represents dataset "Warfarin Sample 2" for domain "drug" and was generated for All of Us Registered Tier Dataset v6 
dataset_77836918_drug_sql = """ 
    SELECT 
        d_exposure.person_id, 
        d_exposure.drug_concept_id, 
        d_standard_concept.concept_name as standard_concept_name, 
        d_standard_concept.concept_code as standard_concept_code, 
        d_standard_concept.vocabulary_id as standard_vocabulary, 
        d_exposure.drug_exposure_start_datetime, 
        d_exposure.drug_exposure_end_datetime, 
        d_exposure.verbatim_end_date, 
        d_exposure.drug_type_concept_id, 
        d_type.concept_name as drug_type_concept_name, 
        d_exposure.stop_reason, 
        d_exposure.refills, 
        d_exposure.quantity, 
        d_exposure.days_supply, 
        d_exposure.sig, 
        d_exposure.route_concept_id, 
        d_route.concept_name as route_concept_name, 
        d_exposure.lot_number, 
        d_exposure.visit_occurrence_id, 
        d_visit.concept_name as visit_occurrence_concept_name, 
        d_exposure.drug_source_value, 
        d_exposure.drug_source_concept_id, 
        d_source_concept.concept_name as source_concept_name, 
        d_source_concept.concept_code as source_concept_code, 
        d_source_concept.vocabulary_id as source_vocabulary, 
        d_exposure.route_source_value, 
        d_exposure.dose_unit_source_value  
    FROM 
        ( SELECT 
            *  
        FROM 
            `""" + os.environ["WORKSPACE_CDR"] + """.drug_exposure` d_exposure  
        WHERE 
            ( 
                drug_concept_id IN  ( 
                    SELECT 
                        DISTINCT ca.descendant_id  
                    FROM 
                        `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria_ancestor` ca  
                    JOIN 
                        ( 
                            select 
                                distinct c.concept_id  
                            FROM 
                                `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` c  
                            JOIN 
                                ( 
                                    select 
                                        cast(cr.id as string) as id  
                                    FROM 
                                        `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` cr  
                                    WHERE 
                                        concept_id IN ( 
                                            1310149, 21603553 
                                        )  
                                        AND full_text LIKE '%_rank1]%' 
                                ) a  
                                    ON ( 
                                        c.path LIKE CONCAT('%.', 
                                    a.id, 
                                    '.%')  
                                    OR c.path LIKE CONCAT('%.', 
                                    a.id)  
                                    OR c.path LIKE CONCAT(a.id, 
                                    '.%')  
                                    OR c.path = a.id)  
                                WHERE 
                                    is_standard = 1  
                                    AND is_selectable = 1 
                                ) b  
                                    ON ( 
                                        ca.ancestor_id = b.concept_id 
                                    ) 
                            ) 
                        )   
                        AND ( 
                            d_exposure.PERSON_ID IN ( 
                                SELECT 
                                    distinct person_id   
                            FROM 
                                `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_person` cb_search_person   
                            WHERE 
                                cb_search_person.person_id IN ( 
                                    SELECT 
                                        criteria.person_id  
                                    FROM 
                                        (SELECT 
                                            DISTINCT person_id, 
                                            entry_date, 
                                            concept_id  
                                        FROM 
                                            `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                                        WHERE 
                                            ( 
                                                concept_id IN ( 
                                                    SELECT 
                                                        DISTINCT ca.descendant_id  
                                                    FROM 
                                                        `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria_ancestor` ca  
                                                    JOIN 
                                                        ( 
                                                            select 
                                                                distinct c.concept_id  
                                                            FROM 
                                                                `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` c  
                                                            JOIN 
                                                                ( 
                                                                    select 
                                                                        cast(cr.id as string) as id  
                                                                    FROM 
                                                                        `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` cr  
                                                                    WHERE 
                                                                        concept_id IN (1310149)  
                                                                        AND full_text LIKE '%_rank1]%' 
                                                                ) a  
                                                                    ON ( 
                                                                        c.path LIKE CONCAT('%.', 
                                                                    a.id, 
                                                                    '.%')  
                                                                    OR c.path LIKE CONCAT('%.', 
                                                                    a.id)  
                                                                    OR c.path LIKE CONCAT(a.id, 
                                                                    '.%')  
                                                                    OR c.path = a.id)  
                                                                WHERE 
                                                                    is_standard = 1  
                                                                    AND is_selectable = 1 
                                                                ) b  
                                                                    ON ( 
                                                                        ca.ancestor_id = b.concept_id 
                                                                    ) 
                                                            )  
                                                            AND is_standard = 1 
                                                        ) 
                                                ) criteria  
                                            )  
                                            AND cb_search_person.person_id IN ( 
                                                SELECT 
                                                    person_id  
                                            FROM 
                                                `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                                            WHERE 
                                                person_id IN ( 
                                                    SELECT 
                                                        person_id  
                                                    FROM 
                                                        `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                                                    WHERE 
                                                        concept_id IN ( 
                                                            SELECT 
                                                                DISTINCT c.concept_id  
                                                            FROM 
                                                                `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` c  
                                                            JOIN 
                                                                ( 
                                                                    select 
                                                                        cast(cr.id as string) as id  
                                                                    FROM 
                                                                        `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` cr  
                                                                    WHERE 
                                                                        concept_id IN (1585860, 1585857)  
                                                                        AND full_text LIKE '%_rank1]%' 
                                                                ) a  
                                                                    ON ( 
                                                                        c.path LIKE CONCAT('%.', 
                                                                    a.id, 
                                                                    '.%')  
                                                                    OR c.path LIKE CONCAT('%.', 
                                                                    a.id)  
                                                                    OR c.path LIKE CONCAT(a.id, 
                                                                    '.%')  
                                                                    OR c.path = a.id)  
                                                                WHERE 
                                                                    is_standard = 0  
                                                                    AND is_selectable = 1 
                                                                )  
                                                                AND is_standard = 0  
                                                        ) 
                                                    )  
                                                    AND cb_search_person.person_id IN ( 
                                                        SELECT 
                                                            criteria.person_id  
                                                        FROM 
                                                            (SELECT 
                                                                DISTINCT person_id, 
                                                                entry_date, 
                                                                concept_id  
                                                            FROM 
                                                                `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                                                            WHERE 
                                                                ( 
                                                                    concept_id IN ( 
                                                                        SELECT 
                                                                            DISTINCT ca.descendant_id  
                                                                        FROM 
                                                                            `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria_ancestor` ca  
                                                                        JOIN 
                                                                            ( 
                                                                                select 
                                                                                    distinct c.concept_id  
                                                                                FROM 
                                                                                    `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` c  
                                                                                JOIN 
                                                                                    ( 
                                                                                        select 
                                                                                            cast(cr.id as string) as id  
                                                                                        FROM 
                                                                                            `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` cr  
                                                                                        WHERE 
                                                                                            concept_id IN (21603553)  
                                                                                            AND full_text LIKE '%_rank1]%' 
                                                                                    ) a  
                                                                                        ON ( 
                                                                                            c.path LIKE CONCAT('%.', 
                                                                                        a.id, 
                                                                                        '.%')  
                                                                                        OR c.path LIKE CONCAT('%.', 
                                                                                        a.id)  
                                                                                        OR c.path LIKE CONCAT(a.id, 
                                                                                        '.%')  
                                                                                        OR c.path = a.id)  
                                                                                    WHERE 
                                                                                        is_standard = 1  
                                                                                        AND is_selectable = 1 
                                                                                    ) b  
                                                                                        ON ( 
                                                                                            ca.ancestor_id = b.concept_id 
                                                                                        ) 
                                                                                )  
                                                                                AND is_standard = 1 
                                                                            ) 
                                                                    ) criteria  
                                                                )  
                                                                AND cb_search_person.person_id IN ( 
                                                                    SELECT 
                                                                        person_id  
                                                                FROM 
                                                                    `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                                                                WHERE 
                                                                    person_id IN ( 
                                                                        SELECT 
                                                                            person_id  
                                                                        FROM 
                                                                            `""" + os.environ["WORKSPACE_CDR"] + """.cb_search_all_events`  
                                                                        WHERE 
                                                                            concept_id IN ( 
                                                                                SELECT 
                                                                                    DISTINCT c.concept_id  
                                                                                FROM 
                                                                                    `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` c  
                                                                                JOIN 
                                                                                    ( 
                                                                                        select 
                                                                                            cast(cr.id as string) as id  
                                                                                        FROM 
                                                                                            `""" + os.environ["WORKSPACE_CDR"] + """.cb_criteria` cr  
                                                                                        WHERE 
                                                                                            concept_id IN (1586198, 1586207)  
                                                                                            AND full_text LIKE '%_rank1]%' 
                                                                                    ) a  
                                                                                        ON ( 
                                                                                            c.path LIKE CONCAT('%.', 
                                                                                        a.id, 
                                                                                        '.%')  
                                                                                        OR c.path LIKE CONCAT('%.', 
                                                                                        a.id)  
                                                                                        OR c.path LIKE CONCAT(a.id, 
                                                                                        '.%')  
                                                                                        OR c.path = a.id)  
                                                                                    WHERE 
                                                                                        is_standard = 0  
                                                                                        AND is_selectable = 1 
                                                                                    )  
                                                                                    AND is_standard = 0  
                                                                            ) 
                                                                        )  
                                                                ) 
                                                            ) 
                                                    ) d_exposure  
                                                LEFT JOIN 
                                                    `""" + os.environ["WORKSPACE_CDR"] + """.concept` d_standard_concept  
                                                        ON d_exposure.drug_concept_id = d_standard_concept.concept_id  
                                                LEFT JOIN 
                                                    `""" + os.environ["WORKSPACE_CDR"] + """.concept` d_type  
                                                        ON d_exposure.drug_type_concept_id = d_type.concept_id  
                                                LEFT JOIN 
                                                    `""" + os.environ["WORKSPACE_CDR"] + """.concept` d_route  
                                                        ON d_exposure.route_concept_id = d_route.concept_id  
                                                LEFT JOIN 
                                                    `""" + os.environ["WORKSPACE_CDR"] + """.visit_occurrence` v  
                                                        ON d_exposure.visit_occurrence_id = v.visit_occurrence_id  
                                                LEFT JOIN 
                                                    `""" + os.environ["WORKSPACE_CDR"] + """.concept` d_visit  
                                                        ON v.visit_concept_id = d_visit.concept_id  
                                                LEFT JOIN 
                                                    `""" + os.environ["WORKSPACE_CDR"] + """.concept` d_source_concept  
                                                        ON d_exposure.drug_source_concept_id = d_source_concept.concept_id""" 
 
dataset_77836918_drug_df = pandas.read_gbq( 
    dataset_77836918_drug_sql, 
    dialect="standard", 
    use_bqstorage_api=("BIGQUERY_STORAGE_API_ENABLED" in os.environ), 
    progress_bar_type="tqdm_notebook") 
 
dataset_77836918_drug_df.head(5) 

 
